name: Go Build

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: 1.23
    # You can test your matrix by printing the current Go version
    - name: Display Go version
      run: go version
    - name: Build it
      run: make V=1
  build-sidecar-container:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: 1.23
    - name: Build Binaries
      id: go_build
      run: make V=1
    - name: Extract metadata (Sidecar tags, labels) for Docker
      id: meta_sidecar
      uses: docker/metadata-action@369eb591f429131d6889c46b94e711f089e6ca96
      with:
        images: ${{ env.REGISTRY }}/hyperspike/valkey-sidecar${{ github.sha }}
    - name: Build and push Sidecar image
      uses: docker/build-push-action@b32b51a8eda65d6793cd0494a773d4f6bcef32dc
      id: docker_build_sidecar
      with:
        file: Dockerfile.sidecar
        context: .
        push: false
        visibility: public
        tags: ${{ env.REGISTRY }}/hyperspike/valkey-sidecar${{ github.sha }}
        labels: ${{ steps.meta_sidecar.outputs.labels }}
